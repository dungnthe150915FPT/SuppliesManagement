@page
@model SuppliesManagement.Pages.NhapMuaHangHoaModel
@{
    //ViewData["Title"] = "Nhập Mua Hàng Hóa";
    //var success = ViewData["Success"]?.ToString();
}

<h2>Nhập Mua Hàng Hóa</h2>

<form method="post">
    <div class="form-group">
        <label for="NhaCungCap">Nhà cung cấp:</label>
        <input type="text" class="form-control" id="NhaCungCap" name="NhaCungCap" required>
    </div>
    <div class="form-group">
        <label for="NgayNhap">Ngày nhập:</label>
        <input type="date" class="form-control" id="NgayNhap" name="NgayNhap" required>
    </div>
    <div class="form-group">
        <label for="KhoHangID">Nhập vào đơn vị:</label>
        <select class="form-control" name="khoHangID" required>
            @if (Model.KhoHangs != null && Model.KhoHangs.Any())
            {
                foreach (var kho in Model.KhoHangs)
                {
                    <option value="@kho.ID">@kho.TenKho - @kho.DiaChi</option>
                }
            }
            else
            {
                <option disabled>Không có dữ liệu kho hàng</option>
            }
        </select>

    </div>
    <div class="form-group">
        <label for="SoSerial">Số Serial:</label>
        <input type="text" class="form-control" id="SoSerial" name="SoSerial">
    </div>
    <div class="form-group">
        <label for="SoHoaDon">Số hóa đơn:</label>
        <input type="text" class="form-control" id="SoHoaDon" name="SoHoaDon">
    </div>
    <div class="form-group">
        <label for="ThanhTien">Tổng số tiền (Chưa tính VAT):</label>
        <input type="text" class="form-control" id="ThanhTien" name="ThanhTien" readonly>
    </div>
    <br>

    <div class="table-responsive">
        <table class="table custom-table">
            <thead class="thead-dark">
                <tr>
                    <th>STT</th>
                    <th>Hàng hóa</th>
                    <th>Nhóm hàng hóa</th>
                    <th>Số lượng</th>
                    <th>Đơn vị tính</th>
                    <th>Giá tr.thuế</th>
                    <th>VAT%</th>
                    <th>Giá s.thuế</th>
                    <th>Tiền hàng</th>
                    <th>Tổng tiền</th>
                </tr>
            </thead>
            <tbody id="hangHoaTableBody">
                @for (int i = 0; i < 1; i++)
                {
                    <tr>
                        <th>@(i + 1)</th>
                        <td><input type="text" class="form-control" name="hangHoaModels[@i].TenHangHoa" required></td>
                        <td>
                            <select class="form-control" name="hangHoaModels[@i].NhomHangID" required>
                                @if (Model.NhomHangs != null && Model.NhomHangs.Any())
                                {
                                    @foreach (var nhomHang in Model.NhomHangs)
                                    {
                                        <option value="@nhomHang.ID">@nhomHang.Name</option>
                                    }
                                }
                                else
                                {
                                    <option disabled>Không có dữ liệu nhóm hàng</option>
                                }
                            </select>
                        </td>
                        <td><input type="number" class="form-control" name="hangHoaModels[@i].SoLuong" min="1" required oninput="calculateTotals(this.closest('tr'))"></td>
                        <td>
                            <select class="form-control" name="hangHoaModels[@i].DonViTinhID" required>
                                @if (Model.DonViTinhs != null && Model.DonViTinhs.Any())
                                {
                                    @foreach (var donViTinh in Model.DonViTinhs)
                                    {
                                        <option value="@donViTinh.ID">@donViTinh.Name</option>
                                    }
                                }
                                else
                                {
                                    <option disabled>Không có dữ liệu đơn vị tính</option>
                                }
                            </select>
                        </td>
                        <td><input type="text" class="form-control" name="hangHoaModels[@i].DonGiaTruocThue" min="0" required oninput="calculateTotals(this.closest('tr'))"></td>
                        <td><input type="number" class="form-control" name="hangHoaModels[@i].VAT" min="0" max="10" required oninput="calculateTotals(this.closest('tr'))"></td>
                        <td><input type="text" class="form-control" name="hangHoaModels[@i].DonGiaSauThue" readonly></td>
                        <td><input type="text" class="form-control" name="hangHoaModels[@i].TongGiaTruocThue" readonly></td>
                        <td><input type="text" class="form-control" name="hangHoaModels[@i].TongGiaSauThue" readonly></td>
                    </tr>
                }
            </tbody>
        </table>
        <button type="button" class="btn btn-secondary" id="addRow">Thêm Hàng Hóa</button>
        <button type="submit" class="btn btn-primary">Lưu thông tin</button>
    </div>
    @*@if (!string.IsNullOrWhiteSpace(success))
    {
    <div class="alert alert-success" role="alert">
    @success
    </div>
    }*@
</form>

<script>
    let hangHoaCount = 1; // Start with one row

    document.getElementById('addRow').addEventListener('click', function () {
        const tableBody = document.getElementById('hangHoaTableBody');
        // Create a new row
        const newRow = document.createElement('tr');
        newRow.innerHTML = `
                        <th>${hangHoaCount + 1}</th>
                        <td><input type="text" class="form-control" name="hangHoaModels[${hangHoaCount}].TenHangHoa" required></td>
                        <td>
                            <select class="form-control" name="hangHoaModels[${hangHoaCount}].NhomHangID" required>
    @if (Model.NhomHangs != null && Model.NhomHangs.Any())
    {
        @foreach (var nhomHang in Model.NhomHangs)
        {
                                                                            <option value="@nhomHang.ID">@nhomHang.Name</option>
        }
    }
    else
    {
                                                            <option disabled>Không có dữ liệu nhóm hàng</option>
    }
                            </select>
                        </td>
                        <td><input type="number" class="form-control" name="hangHoaModels[${hangHoaCount}].SoLuong" min="1" required oninput="calculateTotals(this.closest('tr'))"></td>
                        <td>
                            <select class="form-control" name="hangHoaModels[${hangHoaCount}].DonViTinhID" required>
    @if (Model.DonViTinhs != null && Model.DonViTinhs.Any())
    {
        @foreach (var donViTinh in Model.DonViTinhs)
        {
                                                                <option value="@donViTinh.ID">@donViTinh.Name</option>
        }
    }
    else
    {
                                                    <option disabled>Không có dữ liệu đơn vị tính</option>
    }
                            </select>
                        </td>
                            <td><input type="number" class="form-control" name="hangHoaModels[${hangHoaCount}].DonGiaTruocThue" min="0" required oninput="calculateTotals(this.closest('tr'))"></td>
                        <td><input type="number" class="form-control" name="hangHoaModels[${hangHoaCount}].VAT" min="0" max="10" required oninput="calculateTotals(this.closest('tr'))"></td>
                            <td><input type="text" class="form-control" name="hangHoaModels[${hangHoaCount}].DonGiaSauThue" readonly></td>
                            <td><input type="text" class="form-control" name="hangHoaModels[${hangHoaCount}].TongGiaTruocThue" readonly></td>
                            <td><input type="text" class="form-control" name="hangHoaModels[${hangHoaCount}].TongGiaSauThue" readonly></td>
                    `;
        tableBody.appendChild(newRow);
        hangHoaCount++;
        setupRow(newRow); // Set up event listeners for the new row
    });

    function setupRow(row) {
        row.querySelector('input[name*="SoLuong"]').addEventListener('input', () => calculateTotals(row));
        row.querySelector('input[name*="DonGiaTruocThue"]').addEventListener('input', () => calculateTotals(row));
        row.querySelector('input[name*="VAT"]').addEventListener('input', () => calculateTotals(row));
    }
    // Adding event listeners to existing rows
    document.querySelectorAll('.custom-table tbody tr').forEach(row => setupRow(row));

    function calculateTotals(row) {
        const qty = parseFloat(row.querySelector('input[name*="SoLuong"]').value) || 0;
        const priceBeforeTax = parseFloat(row.querySelector('input[name*="DonGiaTruocThue"]').value) || 0;
        const vat = parseFloat(row.querySelector('input[name*="VAT"]').value) || 0;

        // Calculate price after tax
        const priceAfterTax = priceBeforeTax * (1 + vat / 100);
        row.querySelector('input[name*="DonGiaSauThue"]').value = priceAfterTax.toFixed(0);

        // Calculate total before tax
        const totalBeforeTax = qty * priceBeforeTax;
        row.querySelector('input[name*="TongGiaTruocThue"]').value = totalBeforeTax.toFixed(0);

        // Calculate total after tax
        const totalAfterTax = qty * priceAfterTax;
        row.querySelector('input[name*="TongGiaSauThue"]').value = totalAfterTax.toFixed(0);

        // Update total amount
        updateTotalAmount();
    }

    function updateTotalAmount() {
        let totalAmount = 0;

        const rows = document.querySelectorAll('.custom-table tbody tr');
        rows.forEach(row => {
            const totalRow = parseFloat(row.querySelector('input[name*="TongGiaTruocThue"]').value) || 0;
            totalAmount += totalRow;
        });

        document.getElementById('ThanhTien').value = totalAmount.toFixed(0);
    }
</script>